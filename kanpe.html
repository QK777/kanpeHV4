<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FF14 カンペ（十字/X字 + マーカー）</title>
  <style>
    :root{
      --app-bg:#0b0f14;
      --text:#e6edf3;
      --muted:rgba(230,237,243,.72);
      --border:#3a4654;
      --shadow:0 10px 26px rgba(0,0,0,.45);
      --viewer-border:#3d3f44;

      /* t1っぽい色 */
      --pink:#ff9aa2;
      --yellow:#fff2a1;
      --blue:#9ad9ff;
      --purple:#d1b3ff;

      /* ボタンサイズ（端末幅に応じて自動調整） */
      --sq: clamp(62px, 10.5vw, 86px);
      --ci: clamp(68px, 11.5vw, 92px);
      --sq-font: clamp(34px, 6.2vw, 58px);
      --ci-font: clamp(38px, 6.8vw, 66px);

      /* タップしやすい当たり判定の余白 */
      --hit-pad: 10px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--app-bg);
      color:var(--text);
      font-family:"Segoe UI", system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    header{
      padding:10px 12px;
      background:#111821;
      display:flex;
      gap:10px;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,.06);
      flex-wrap:wrap;
    }

    .spacer{ flex:1; }

    .topbtn{
      background:#141b22;
      color:var(--text);
      border:1px solid var(--border);
      padding:8px 14px;
      border-radius:12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .topbtn:hover{ filter:brightness(1.06); }

    #status{
      font-size:12px;
      color:var(--muted);
      margin-left:2px;
    }

    #wrap{
      display:flex;
      gap:22px;
      padding:18px;
      align-items:stretch;
    }

    #leftPanel{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .sectionTitle{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.02em;
      margin-left:2px;
      margin-top:6px;
    }

    /* 十字 / X字 行 */
    #topRow{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .choiceBtn{
      min-width:150px;
      height:56px;
      padding:0 14px;
      border-radius:18px;
      border:2px solid rgba(255,255,255,.14);
      background:#0f141a;
      color:var(--text);
      font-size:22px;
      font-weight:800;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.38);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .choiceBtn.cross{ border-color: rgba(79,195,247,.9); }
    .choiceBtn.x{ border-color: rgba(255,111,97,.9); }
    .choiceBtn.active{ outline:3px solid rgba(255,255,255,.88); outline-offset:3px; }

    /* t1の左側っぽい黒いボード */
    #pad{
      position:relative;
      width:100%;
      max-width:520px;
      aspect-ratio: 420 / 340;
      background:#000;
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .token{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%, -50%);
      display:flex;
      align-items:center;
      justify-content:center;
      border:3px solid #000;
      color:#000;
      font-weight:900;
      user-select:none;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.38);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* 当たり判定を少し広げる（見た目は変えない） */
    .token::before{
      content:"";
      position:absolute;
      inset: calc(-1 * var(--hit-pad));
      border-radius:999px;
    }

    .token.square{
      width:var(--sq);
      height:var(--sq);
      border-radius:12px;
      font-size:var(--sq-font);
    }
    .token.circle{
      width:var(--ci);
      height:var(--ci);
      border-radius:999px;
      font-size:var(--ci-font);
    }

    .token.pink{ background:var(--pink); }
    .token.yellow{ background:var(--yellow); }
    .token.blue{ background:var(--blue); }
    .token.purple{ background:var(--purple); }

    .token.active{
      outline:4px solid rgba(255,255,255,.88);
      outline-offset:4px;
    }

    /* 配置編集中はスクロールを止めつつドラッグしやすく */
    body.layout-edit .token,
    body.layout-edit .choiceBtn{
      touch-action:none;
      cursor:grab;
    }
    body.layout-edit .token:active,
    body.layout-edit .choiceBtn:active{
      cursor:grabbing;
    }

    .config{
      opacity:.9;
      font-size:12px;
      line-height:1.55;
      margin-left:4px;
      color:var(--muted);
    }

    .hidden{ display:none; }

    /* 右側：2段ビューア */
    #viewerStack{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:340px;
    }

    .viewerPanel{
      background:#fff;
      border:6px solid var(--viewer-border);
      border-radius:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      min-height:160px;
      touch-action: pan-y; /* 縦スクロールは許可、横スワイプは自前 */
    }

    .viewerPanel img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      display:block;
    }

    .placeholder{
      color:#666;
      font-weight:700;
      letter-spacing:.02em;
      padding:18px;
      text-align:center;
    }

    .swipeHint{
      position:absolute;
      left:12px;
      bottom:10px;
      font-size:11px;
      color:rgba(0,0,0,.55);
      background:rgba(255,255,255,.72);
      border:1px solid rgba(0,0,0,.08);
      padding:6px 8px;
      border-radius:12px;
      user-select:none;
      pointer-events:none;
    }

    .viewerLabel{
      position:absolute;
      right:12px;
      top:10px;
      font-size:11px;
      color:rgba(0,0,0,.62);
      background:rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.08);
      padding:6px 8px;
      border-radius:12px;
      user-select:none;
      pointer-events:none;
    }

    .dividerLine{
      height:1px;
      background:rgba(255,255,255,.18);
      border:0;
      margin:0;
    }

    @media (max-width: 980px){
      #wrap{ flex-direction:column; }
      #leftPanel{ width:auto; }
      #viewerStack{ min-height: 320px; }
      .choiceBtn{ min-width: 140px; height:54px; font-size:20px; }
      .viewerPanel{ min-height: 180px; }
    }

    @media (max-width: 520px){
      .viewerPanel{ min-height: 200px; }
    }
  </style>
</head>
<body>
  <header>
    <button class="topbtn" id="modeBtn">設定モード</button>
    <button class="topbtn" id="layoutBtn" title="ボタン位置をドラッグで移動できます">配置編集:OFF</button>
    <button class="topbtn" id="resetLayoutBtn" title="ボタン位置を初期配置に戻します">配置をリセット</button>
    <button class="topbtn" id="clearImagesBtn" title="このブラウザに保存した画像割り当てを消します">画像割り当て全消去</button>
    <span id="status"></span>
    <span class="spacer"></span>
    <span style="font-size:12px;color:var(--muted);">
      PC: Alt+クリックで解除 / iPad・iPhone: <b>長押し</b>で解除
    </span>
  </header>

  <div id="wrap">
    <div id="leftPanel">
      <div class="sectionTitle">十字 / X字</div>
      <div id="topRow" aria-label="十字・X字ボタン">
        <button class="choiceBtn cross" data-key="CROSS">十字</button>
        <button class="choiceBtn x" data-key="X">X字</button>
      </div>

      <div class="sectionTitle">マーカー（1 / 2 / 3 / 4 / A / B / C / D）</div>
      <div id="pad" aria-label="マーカー切替ボタン"></div>

      <div class="config" id="configHint">
        ※ <b>設定モード</b>：タップ → 画像を登録（ブラウザに保存） / PCは Alt+タップ、iOSは長押しで解除<br>
        ※ <b>使用モード</b>：タップ → 右の各エリアに表示 / 右の表示エリアを<b>左右スワイプ</b>で前後切替<br>
        ※ <b>配置編集</b>：マーカーをドラッグして位置調整（iPad/iPhoneでもOK）
      </div>
    </div>

    <div id="viewerStack" aria-label="表示エリア">
      <div class="viewerPanel" id="viewerTop" aria-label="十字/X字の画像表示">
        <span class="placeholder" id="phTop">十字/X字：画像未選択</span>
        <div class="swipeHint">←→ スワイプで切替</div>
        <div class="viewerLabel">十字 / X字</div>
      </div>

      <hr class="dividerLine" />

      <div class="viewerPanel" id="viewerMain" aria-label="マーカーの画像表示">
        <span class="placeholder" id="phMain">マーカー：画像未選択（A/B はデモ）</span>
        <div class="swipeHint">←→ スワイプで切替</div>
        <div class="viewerLabel">マーカー</div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // 保存キー
    // =========================
    const STORAGE_IMAGES = "ff14_kanpe_images_v4";
    const STORAGE_POS    = "ff14_kanpe_positions_v4";

    // =========================
    // デフォルト画像（同フォルダに置けばそのまま動く）
    // =========================
    const DEFAULT_IMAGES = {
      A: "./t2.png",
      B: "./t3.png",
    };

    // =========================
    // ボタン定義（%座標）
    // - x/y は #pad 内の割合（0-100）
    // =========================
    const MAIN_BUTTONS = [
      // 四角
      { key: "1", label: "1", shape: "square", color: "pink",   x: 16, y: 26 },
      { key: "2", label: "2", shape: "square", color: "yellow", x: 66, y: 26 },
      { key: "3", label: "3", shape: "square", color: "blue",   x: 66, y: 76 },
      { key: "4", label: "4", shape: "square", color: "purple", x: 20, y: 74 },
      // 丸
      { key: "A", label: "A", shape: "circle", color: "pink",   x: 38, y: 10 },
      { key: "B", label: "B", shape: "circle", color: "yellow", x: 86, y: 50 },
      { key: "C", label: "C", shape: "circle", color: "blue",   x: 40, y: 90 },
      { key: "D", label: "D", shape: "circle", color: "purple", x: 10, y: 50 },
    ];

    // スワイプ切替の順番
    const ORDER_TOP  = ["CROSS", "X"];
    const ORDER_MAIN = ["1","2","3","4","A","B","C","D"];

    // =========================
    // 状態
    // =========================
    let useMode = false;      // false=設定 / true=使用
    let layoutEdit = false;   // 位置編集

    const state = {
      images: {},             // { key: dataURL }
      pos: {},                // { key: {x,y} } (%座標)
      activeTop: null,
      activeMain: null,
    };

    const pad = document.getElementById("pad");
    const topRow = document.getElementById("topRow");

    const viewerTop  = document.getElementById("viewerTop");
    const viewerMain = document.getElementById("viewerMain");
    const phTop  = document.getElementById("phTop");
    const phMain = document.getElementById("phMain");

    const modeBtn = document.getElementById("modeBtn");
    const layoutBtn = document.getElementById("layoutBtn");
    const resetLayoutBtn = document.getElementById("resetLayoutBtn");
    const clearImagesBtn = document.getElementById("clearImagesBtn");
    const status = document.getElementById("status");

    function setStatus(text){ status.textContent = text || ""; }

    function saveImages(){
      try{ localStorage.setItem(STORAGE_IMAGES, JSON.stringify(state.images)); }
      catch(e){
        console.warn(e);
        alert("保存に失敗しました（画像が大きすぎる可能性があります）。\nサイズを小さくして再度お試しください。");
      }
    }

    function loadImages(){
      try{
        const raw = localStorage.getItem(STORAGE_IMAGES);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object") state.images = obj;
      }catch(e){ console.warn(e); }
    }

    function clearImages(){
      localStorage.removeItem(STORAGE_IMAGES);
      state.images = {};
      setStatus("画像割り当てを消去しました");
      if(state.activeTop)  showTop(state.activeTop);
      if(state.activeMain) showMain(state.activeMain);
    }

    function savePos(){
      try{ localStorage.setItem(STORAGE_POS, JSON.stringify(state.pos)); }
      catch(e){ console.warn(e); }
    }

    function loadPos(){
      try{
        const raw = localStorage.getItem(STORAGE_POS);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object") state.pos = obj;
      }catch(e){ console.warn(e); }
    }

    function resetPos(){
      state.pos = {};
      localStorage.removeItem(STORAGE_POS);
      buildMainButtons();
      setStatus("配置をリセットしました");
    }

    // 画像選択（2度開き防止）
    function pickImageAsDataURL(cb){
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.onchange = (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => cb(String(reader.result));
        reader.onerror = () => alert("画像の読み込みに失敗しました");
        reader.readAsDataURL(file);
      };
      input.click();
    }

    function getImageForKey(key){
      return state.images[key] || DEFAULT_IMAGES[key] || null;
    }

    function renderPanel(panelEl, placeholderEl, imgSrc){
      const old = panelEl.querySelector("img");
      if(old) old.remove();

      if(!imgSrc){
        placeholderEl.classList.remove("hidden");
        return;
      }
      placeholderEl.classList.add("hidden");
      const img = document.createElement("img");
      img.src = imgSrc;
      panelEl.appendChild(img);
    }

    function setActiveTop(key){
      state.activeTop = key;
      [...topRow.querySelectorAll(".choiceBtn")].forEach(btn => {
        btn.classList.toggle("active", btn.dataset.key === key);
      });
    }

    function setActiveMain(key){
      state.activeMain = key;
      [...pad.querySelectorAll(".token")].forEach(btn => {
        btn.classList.toggle("active", btn.dataset.key === key);
      });
    }

    function showTop(key){
      setActiveTop(key);
      const img = getImageForKey(key);
      renderPanel(viewerTop, phTop, img);
      setStatus(img ? `十字/X字 表示：${key}` : `十字/X字 表示：${key}（未登録）`);
    }

    function showMain(key){
      setActiveMain(key);
      const img = getImageForKey(key);
      renderPanel(viewerMain, phMain, img);
      setStatus(img ? `マーカー 表示：${key}` : `マーカー 表示：${key}（未登録）`);
    }

    function clearKey(key, group){
      if(state.images[key]){
        delete state.images[key];
        saveImages();
      }
      setStatus(`解除：${key}`);
      if(group === "top") showTop(key);
      else showMain(key);
    }

    // =========================
    // タップ/長押し共通ハンドラ
    // =========================
    const LONGPRESS_MS = 560;

    function attachTapHandlers(el, key, group){
      let lpTimer = null;
      let moved = false;
      let startX = 0, startY = 0;
      let suppressClickUntil = 0; // 2度ファイルピッカー防止

      const onPointerDown = (ev) => {
        if(layoutEdit) return;
        moved = false;
        startX = ev.clientX;
        startY = ev.clientY;

        // iOS向け：長押しで解除（設定モードのみ）
        if(!useMode){
          lpTimer = setTimeout(() => {
            lpTimer = null;
            clearKey(key, group);
          }, LONGPRESS_MS);
        }
      };

      const onPointerMove = (ev) => {
        if(layoutEdit) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        if(Math.abs(dx) + Math.abs(dy) > 10){
          moved = true;
          if(lpTimer){ clearTimeout(lpTimer); lpTimer = null; }
        }
      };

      const onPointerUp = (ev) => {
        if(layoutEdit) return;
        suppressClickUntil = Date.now() + 450;
        if(lpTimer){ clearTimeout(lpTimer); lpTimer = null; }
        if(moved) return;

        // PC：Altで解除
        if(!useMode && ev.altKey){
          clearKey(key, group);
          return;
        }

        if(!useMode){
          pickImageAsDataURL((dataURL) => {
            state.images[key] = dataURL;
            saveImages();
            setStatus(`登録：${key}`);
            if(group === "top") showTop(key);
            else showMain(key);
          });
          return;
        }

        if(group === "top") showTop(key);
        else showMain(key);
      };

      el.addEventListener("pointerdown", onPointerDown);
      el.addEventListener("pointermove", onPointerMove);
      el.addEventListener("pointerup", onPointerUp);
      el.addEventListener("pointercancel", () => { if(lpTimer){ clearTimeout(lpTimer); lpTimer=null; } });

      // click フォールバック（ただし pointerup 後は抑止して 2度起動を防ぐ）
      el.addEventListener("click", (ev) => {
        if(Date.now() < suppressClickUntil) return;
        if(layoutEdit) return;

        if(!useMode && ev.altKey){ clearKey(key, group); return; }

        if(!useMode){
          pickImageAsDataURL((dataURL) => {
            state.images[key] = dataURL;
            saveImages();
            setStatus(`登録：${key}`);
            if(group === "top") showTop(key);
            else showMain(key);
          });
        }else{
          if(group === "top") showTop(key);
          else showMain(key);
        }
      });
    }

    // =========================
    // 配置編集（ドラッグ）
    // =========================
    function attachDrag(el, key){
      let dragging = false;
      let pointerId = null;

      const onDown = (ev) => {
        if(!layoutEdit) return;
        dragging = true;
        pointerId = ev.pointerId;
        el.setPointerCapture(pointerId);
        ev.preventDefault();
      };

      const onMove = (ev) => {
        if(!layoutEdit || !dragging || ev.pointerId !== pointerId) return;
        const rect = pad.getBoundingClientRect();
        const r = el.getBoundingClientRect();
        const halfW = r.width / 2;
        const halfH = r.height / 2;

        let x = ev.clientX - rect.left;
        let y = ev.clientY - rect.top;

        x = Math.max(halfW + 4, Math.min(rect.width  - halfW - 4, x));
        y = Math.max(halfH + 4, Math.min(rect.height - halfH - 4, y));

        const xp = (x / rect.width)  * 100;
        const yp = (y / rect.height) * 100;

        el.style.left = xp + "%";
        el.style.top  = yp + "%";

        state.pos[key] = { x: xp, y: yp };
        savePos();
      };

      const onUp = (ev) => {
        if(!layoutEdit || !dragging || ev.pointerId !== pointerId) return;
        dragging = false;
        pointerId = null;
        try{ el.releasePointerCapture(ev.pointerId); }catch(_){ }
        setStatus(`配置変更：${key}`);
      };

      el.addEventListener("pointerdown", onDown);
      el.addEventListener("pointermove", onMove);
      el.addEventListener("pointerup", onUp);
      el.addEventListener("pointercancel", onUp);
    }

    // =========================
    // UI生成
    // =========================
    function buildTopButtons(){
      [...topRow.querySelectorAll(".choiceBtn")].forEach(btn => {
        const key = btn.dataset.key;
        attachTapHandlers(btn, key, "top");
      });
    }

    function buildMainButtons(){
      pad.innerHTML = "";
      MAIN_BUTTONS.forEach(cfg => {
        const b = document.createElement("button");
        b.className = `token ${cfg.shape} ${cfg.color}`;
        b.textContent = cfg.label;
        b.dataset.key = cfg.key;

        const p = state.pos[cfg.key] || { x: cfg.x, y: cfg.y };
        b.style.left = p.x + "%";
        b.style.top  = p.y + "%";

        attachTapHandlers(b, cfg.key, "main");
        attachDrag(b, cfg.key);

        pad.appendChild(b);
      });
    }

    // =========================
    // スワイプ（各ビューア）
    // =========================
    function attachSwipe(panelEl, order, getActiveKey, showFn){
      let tracking = false;
      let startX = 0, startY = 0;
      let moved = false;

      const indexInOrder = (key) => {
        const idx = order.indexOf(key);
        return idx >= 0 ? idx : 0;
      };

      const showByIndex = (idx) => {
        const key = order[(idx + order.length) % order.length];
        showFn(key);
      };

      panelEl.addEventListener("pointerdown", (ev) => {
        if(layoutEdit) return;
        tracking = true;
        moved = false;
        startX = ev.clientX;
        startY = ev.clientY;
      });

      panelEl.addEventListener("pointermove", (ev) => {
        if(!tracking || layoutEdit) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        if(Math.abs(dx) + Math.abs(dy) > 12) moved = true;
      });

      panelEl.addEventListener("pointerup", (ev) => {
        if(!tracking || layoutEdit) return;
        tracking = false;

        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        if(!moved) return;

        if(Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy) * 1.3) return;

        const cur = getActiveKey() || order[0];
        const idx = indexInOrder(cur);
        if(dx < 0) showByIndex(idx + 1);
        else showByIndex(idx - 1);
      });

      panelEl.addEventListener("pointercancel", () => { tracking = false; });
    }

    // =========================
    // ヘッダーボタン
    // =========================
    modeBtn.addEventListener("click", () => {
      useMode = !useMode;
      modeBtn.textContent = useMode ? "使用モード" : "設定モード";
      setStatus(useMode ? "使用モード：タップで表示" : "設定モード：タップで登録" );
    });

    layoutBtn.addEventListener("click", () => {
      layoutEdit = !layoutEdit;
      document.body.classList.toggle("layout-edit", layoutEdit);
      layoutBtn.textContent = layoutEdit ? "配置編集:ON" : "配置編集:OFF";
      setStatus(layoutEdit ? "配置編集：ドラッグで移動" : "配置編集を終了しました");
    });

    resetLayoutBtn.addEventListener("click", () => {
      const ok = confirm("マーカー配置を初期状態に戻します。よろしいですか？");
      if(ok) resetPos();
    });

    clearImagesBtn.addEventListener("click", () => {
      const ok = confirm("このブラウザに保存した『ボタン→画像』の割り当てを全て消します。よろしいですか？");
      if(ok) clearImages();
    });

    // =========================
    // 初期化
    // =========================
    loadImages();
    loadPos();
    buildTopButtons();
    buildMainButtons();

    // スワイプは各ビューアで独立
    attachSwipe(viewerTop,  ORDER_TOP,  () => state.activeTop,  showTop);
    attachSwipe(viewerMain, ORDER_MAIN, () => state.activeMain, showMain);

    // 初期表示
    showTop("CROSS");
    showMain("A");
    setStatus("設定モード：タップで登録 / iOSは長押しで解除");
  </script>
</body>
</html>
